\set perc ARRAY[0.0, 0.05, 0.23076923076923078, 0.25, 0.37500000000000006, 0.4736842105263158, 0.5, 0.5454545454545455, 0.6, 0.6428571428571428, 0.6774193548387096, 0.7058823529411764, 0.7297297297297297, 0.7499999999999999, 0.75, 0.7674418604651162, 0.7826086956521738, 0.7959183673469388, 0.8076923076923076, 0.8181818181818181, 0.8275862068965517, 0.8360655737704917, 0.8437499999999999, 0.8507462686567163, 0.8571428571428571, 0.8630136986301369, 0.8684210526315789, 0.8734177215189873, 0.8780487804878049, 0.8823529411764706, 0.8863636363636364, 0.8901098901098901, 0.8936170212765957, 0.8969072164948454, 0.9, 0.9230769230769231, 0.9375, 0.9473684210526315, 0.95, 0.9545454545454546, 0.96, 0.9642857142857143, 0.967741935483871, 0.9705882352941176, 0.972972972972973, 0.975, 0.9767441860465116, 0.9782608695652174, 0.9795918367346939, 0.9807692307692307, 0.9818181818181818, 0.9827586206896551, 0.9836065573770492, 0.984375, 0.9850746268656716, 0.9857142857142858, 0.9863013698630136, 0.9868421052631579, 0.9873417721518988, 0.9878048780487805, 0.9882352941176471, 0.9886363636363636, 0.989010989010989, 0.9893617021276596, 0.9896907216494846, 0.99, 0.9923076923076923, 0.99375, 0.9947368421052631, 0.9954545454545455, 0.996, 0.9964285714285714, 0.9967741935483871, 0.9970588235294118, 0.9972972972972973, 0.9975, 0.9976744186046511, 0.9978260869565218, 0.9979591836734694, 0.9980769230769231, 0.9981818181818182, 0.9982758620689656, 0.9983606557377049, 0.9984375, 0.9985074626865672, 0.9985714285714286, 0.9986301369863013, 0.9986842105263158, 0.9987341772151899, 0.998780487804878, 0.9988235294117647, 0.9988636363636364, 0.9989010989010989, 0.9989361702127659, 0.9989690721649485, 0.999, 0.9992307692307693, 0.999375, 0.9994736842105263, 0.9995454545454545, 0.9996, 0.9996428571428572, 0.9996774193548387, 0.9997058823529412, 0.9997297297297297, 0.99975, 0.9997674418604651, 0.9997826086956522, 0.9997959183673469, 0.9998076923076923, 0.9998181818181818, 0.9998275862068966, 0.9998360655737705, 0.99984375, 0.9998507462686567, 0.9998571428571429, 0.9998630136986302, 0.9998684210526316, 0.9998734177215189, 0.9998780487804878, 0.9998823529411764, 0.9998863636363636, 0.9998901098901098, 0.9998936170212765, 0.9998969072164948, 0.9999, 0.9999230769230769, 0.9999375, 0.9999473684210526, 0.9999545454545454, 0.99996, 0.9999642857142857, 0.9999677419354839, 0.9999705882352942, 0.9999729729729729, 0.999975, 0.9999767441860465, 0.9999782608695652, 0.9999795918367347, 0.9999807692307693, 0.9999818181818182, 0.9999827586206896, 0.9999836065573771, 0.999984375, 0.9999850746268657, 0.9999857142857143, 0.999986301369863, 0.9999868421052631, 0.9999873417721519, 0.9999878048780488, 0.9999882352941176, 0.9999886363636363, 0.9999890109890109, 0.9999893617021277, 0.9999896907216494, 0.99999, 0.9999923076923077, 0.99999375, 0.9999947368421053, 0.9999954545454546, 0.999996, 0.9999964285714286, 0.9999967741935484, 0.9999970588235294, 0.9999972972972972, 0.9999975, 0.9999976744186047, 0.9999978260869565, 0.9999979591836735, 0.999998076923077, 0.9999981818181818, 0.999998275862069, 0.9999983606557377, 0.9999984375, 0.9999985074626866, 0.9999985714285714, 0.9999986301369863, 0.9999986842105263, 0.9999987341772152, 0.9999987804878049, 0.9999988235294117, 0.9999988636363636, 0.9999989010989011, 0.9999989361702127, 0.9999989690721649, 0.999999, 0.9999992307692308, 0.999999375, 0.9999994736842105, 0.9999995454545455, 0.9999996, 0.9999996428571428, 0.9999996774193548, 0.999999705882353, 0.9999997297297297, 0.99999975, 0.9999997674418605, 0.9999997826086956, 0.9999997959183673, 0.9999998076923077, 0.9999998181818182, 0.9999998275862069, 0.9999998360655737, 0.99999984375, 0.9999998507462686, 0.9999998571428571, 0.9999998630136986, 0.9999998684210526, 0.9999998734177216, 0.9999998780487804, 0.9999998823529411, 0.9999998863636363, 0.9999998901098901, 0.9999998936170212, 0.9999998969072165, 0.9999999, 0.9999999230769231, 0.9999999375, 0.999999947368421, 0.9999999545454545, 0.99999996, 0.9999999642857142, 0.9999999677419354, 0.9999999705882353, 0.9999999729729729, 0.999999975, 0.9999999767441861, 0.9999999782608696, 0.9999999795918367, 0.9999999807692308, 0.9999999818181818, 0.9999999827586207, 0.9999999836065574, 0.999999984375, 0.9999999850746268, 0.9999999857142857, 0.9999999863013699, 0.9999999868421052, 0.9999999873417722, 0.9999999878048781, 0.9999999882352941, 0.9999999886363636, 0.999999989010989, 0.9999999893617021, 0.9999999896907217, 0.99999999, 0.9999999923076923, 0.99999999375, 0.9999999947368421, 0.9999999954545454, 0.999999996, 0.9999999964285714, 0.9999999967741936, 0.9999999970588235, 0.9999999972972973, 0.9999999975, 0.9999999976744186, 0.999999997826087, 0.9999999979591837, 0.9999999980769231, 0.9999999981818182, 0.9999999982758621, 0.9999999983606558, 0.9999999984375, 0.9999999985074627, 0.9999999985714285, 0.999999998630137, 0.9999999986842105, 0.9999999987341772, 0.9999999987804878, 0.9999999988235294, 0.9999999988636363, 0.9999999989010989, 0.9999999989361702, 0.9999999989690722]
create temp view exporter as

WITH

pre AS (

	select ts, hdr from (
		SELECT ts, hdr, count(1) over (partition by hdr) as c
		FROM pkt
		JOIN capture USING (capture_id)
		WHERE
			capture.name = :'name'
			AND capture."type" = 'pre'
	) as yolo where c = 1
)

, post AS (
	SELECT ts, hdr
	FROM pkt
	JOIN capture USING (capture_id)
	WHERE
		capture.name = :'name'
		AND capture."type" = 'post'
)

, export AS (SELECT
	post.ts - pre.ts as latency,
	pre.ts AS prets,
	post.ts as postts,
	encode(pre.hdr, 'hex')
FROM  pre JOIN  post USING (hdr)
WHERE post.ts > pre.ts
    AND post.ts < pre.ts + 5 * 1e9
    AND post.ts >= (1000000::bigint * (:'trim_ms')::bigint + (SELECT MIN(ts) from post))::bigint)


, evaluator AS (SELECT percentile, 1/(1-percentile) AS onefraconeminuspercentile  FROM UNNEST(:perc) as percentile)

, eval AS (SELECT UNNEST(:perc) as percentile, UNNEST((select percentile_disc(:perc) WITHIN GROUP (order by latency) from export)) as value)

select eval.percentile, eval.value, evaluator.onefraconeminuspercentile from evaluator, eval WHERE evaluator.percentile = eval.percentile order by percentile ASC;

\copy (SELECT * FROM exporter) to pstdout csv header
